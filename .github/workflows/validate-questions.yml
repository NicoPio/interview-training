name: Validate Questions

on:
  pull_request:
    paths:
      - 'content/**/*.md'
  push:
    branches:
      - main
    paths:
      - 'content/**/*.md'

jobs:
  validate:
    name: Validate Question Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate frontmatter format
        run: |
          echo "ðŸ” Validating question frontmatter..."

          ERRORS=0

          for file in $(find content -name "*.md" -not -name "index.md"); do
            echo "Checking: $file"

            # Check if frontmatter exists
            if ! grep -q "^---$" "$file"; then
              echo "âŒ Missing frontmatter in $file"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Extract frontmatter
            FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')

            # Check required fields
            for field in "id:" "slug:" "title:" "category:" "difficulty:" "tags:"; do
              if ! echo "$FRONTMATTER" | grep -q "^$field"; then
                echo "âŒ Missing $field in $file"
                ERRORS=$((ERRORS + 1))
              fi
            done

            # Validate category
            CATEGORY=$(echo "$FRONTMATTER" | grep "^category:" | sed 's/category: *//')
            if [[ ! "$CATEGORY" =~ ^(javascript|html|css|vuejs|reactjs)$ ]]; then
              echo "âŒ Invalid category '$CATEGORY' in $file"
              echo "   Must be one of: javascript, html, css, vuejs, reactjs"
              ERRORS=$((ERRORS + 1))
            fi

            # Validate difficulty
            DIFFICULTY=$(echo "$FRONTMATTER" | grep "^difficulty:" | sed 's/difficulty: *//')
            if [[ ! "$DIFFICULTY" =~ ^(easy|medium|hard)$ ]]; then
              echo "âŒ Invalid difficulty '$DIFFICULTY' in $file"
              echo "   Must be one of: easy, medium, hard"
              ERRORS=$((ERRORS + 1))
            fi

            # Validate ID is a number
            ID=$(echo "$FRONTMATTER" | grep "^id:" | sed 's/id: *//')
            if ! [[ "$ID" =~ ^[0-9]+$ ]]; then
              echo "âŒ Invalid ID '$ID' in $file (must be a number)"
              ERRORS=$((ERRORS + 1))
            fi

            # Validate slug format (kebab-case)
            SLUG=$(echo "$FRONTMATTER" | grep "^slug:" | sed 's/slug: *//' | tr -d "'\"")
            if ! [[ "$SLUG" =~ ^[a-z0-9-]+$ ]]; then
              echo "âŒ Invalid slug '$SLUG' in $file (must be kebab-case)"
              ERRORS=$((ERRORS + 1))
            fi

            # Validate tags format (accept both inline and block YAML formats)
            # Inline format: tags: ['tag1', 'tag2']
            # Block format:  tags:\n  - tag1\n  - tag2
            if ! grep -q "^tags:" "$file"; then
              echo "âŒ Missing tags field in $file"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            exit 1
          else
            echo ""
            echo "âœ… All questions validated successfully!"
          fi

      - name: Check for duplicate IDs
        run: |
          echo "ðŸ” Checking for duplicate question IDs within each locale..."

          HAS_ERRORS=0

          # Check each locale separately
          for locale in fr en; do
            if [ ! -d "content/$locale" ]; then
              continue
            fi

            echo "Checking locale: $locale"

            # Extract all IDs from frontmatter for this locale
            IDS=$(find content/$locale -name "*.md" -not -name "index.md" -exec grep -h "^id:" {} \; | sed 's/id: *//' | sort -n)

            # Check for duplicates
            DUPLICATES=$(echo "$IDS" | uniq -d)

            if [ -n "$DUPLICATES" ]; then
              echo "âŒ Found duplicate IDs in $locale locale:"
              echo "$DUPLICATES"

              # Show which files have duplicate IDs
              for id in $DUPLICATES; do
                echo ""
                echo "Files with ID $id in $locale:"
                find content/$locale -name "*.md" -not -name "index.md" -exec grep -l "^id: $id$" {} \;
              done

              HAS_ERRORS=1
            else
              echo "âœ… No duplicate IDs in $locale locale"
            fi
            echo ""
          done

          if [ $HAS_ERRORS -eq 1 ]; then
            exit 1
          fi

      - name: Check for duplicate slugs
        run: |
          echo "ðŸ” Checking for duplicate slugs within each locale..."

          HAS_ERRORS=0

          # Check each locale separately
          for locale in fr en; do
            if [ ! -d "content/$locale" ]; then
              continue
            fi

            echo "Checking locale: $locale"

            # Extract all slugs from frontmatter for this locale
            SLUGS=$(find content/$locale -name "*.md" -not -name "index.md" -exec grep -h "^slug:" {} \; | sed 's/slug: *//' | tr -d "'\"" | sort)

            # Check for duplicates
            DUPLICATES=$(echo "$SLUGS" | uniq -d)

            if [ -n "$DUPLICATES" ]; then
              echo "âŒ Found duplicate slugs in $locale locale:"
              echo "$DUPLICATES"

              # Show which files have duplicate slugs
              for slug in $DUPLICATES; do
                echo ""
                echo "Files with slug '$slug' in $locale:"
                find content/$locale -name "*.md" -not -name "index.md" -exec grep -l "^slug: ['\"]\\?$slug['\"]\\?$" {} \;
              done

              HAS_ERRORS=1
            else
              echo "âœ… No duplicate slugs in $locale locale"
            fi
            echo ""
          done

          if [ $HAS_ERRORS -eq 1 ]; then
            exit 1
          fi

      - name: Validate markdown syntax
        run: |
          echo "ðŸ” Checking for common markdown issues..."

          ERRORS=0

          for file in $(find content -name "*.md" -not -name "index.md"); do
            # Check for unclosed code blocks
            CODE_BLOCKS=$(grep -c "^\`\`\`" "$file" || true)
            if [ $((CODE_BLOCKS % 2)) -ne 0 ]; then
              echo "âŒ Unclosed code block in $file"
              ERRORS=$((ERRORS + 1))
            fi

            # Check for empty titles
            if grep -q "^title: ''$" "$file" || grep -q "^title: \"\"$" "$file"; then
              echo "âŒ Empty title in $file"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Markdown validation failed with $ERRORS error(s)"
            exit 1
          else
            echo "âœ… Markdown syntax validated successfully!"
          fi

      - name: Generate validation report
        if: always()
        run: |
          echo "ðŸ“Š Question Validation Report"
          echo "=============================="
          echo ""
          echo "Total questions: $(find content -name "*.md" -not -name "index.md" | wc -l)"
          echo ""
          echo "Questions by category:"
          for category in javascript html css vuejs reactjs; do
            count=$(find content -name "*.md" -not -name "index.md" -exec grep -l "^category: $category$" {} \; | wc -l)
            echo "  - $category: $count"
          done
          echo ""
          echo "Questions by difficulty:"
          for difficulty in easy medium hard; do
            count=$(find content -name "*.md" -not -name "index.md" -exec grep -l "^difficulty: $difficulty$" {} \; | wc -l)
            echo "  - $difficulty: $count"
          done
          echo ""
          echo "Questions by locale:"
          for locale in fr en; do
            count=$(find content/$locale -name "*.md" 2>/dev/null | wc -l)
            echo "  - $locale: $count"
          done
